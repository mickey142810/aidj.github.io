<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Mood DJ ‚Äî Dark UI</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg-1:#091226;
    --bg-2:#0f1b2b;
    --card:#0f2433;
    --muted:#9fb3c8;
    --accent:#6ee7b7; /* pleasant green */
    --accent-2:#5aa9ff; /* blue */
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.03);
    --danger: #ff7a7a;
    --glass-border: rgba(255,255,255,0.06);
    --glass-glow: 0 10px 30px rgba(80,170,255,0.06);
  }

  /* page */
  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: radial-gradient(1200px 600px at 10% 10%, #0b2b3a 0%, transparent 10%),
                radial-gradient(900px 500px at 90% 90%, #07203a 0%, transparent 10%),
                linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:#d8eef7;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
    gap:18px;
  }

  /* layout card */
  .app {
    width:100%;
    max-width:980px;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:20px;
    align-items:start;
  }

  /* left column - controller */
  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-glow);
    border-radius:16px;
    padding:18px;
    position:relative;
    overflow:hidden;
  }

  header.brand {
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:8px;
  }
  .logo {
    width:56px;height:56px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;
    box-shadow: 0 6px 18px rgba(90,170,255,0.12);
    font-weight:700;color:#02121a;font-size:18px;
  }
  .brand h1{margin:0;font-size:18px;letter-spacing:-0.2px}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  /* tutorial */
  .howto{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
    border-radius:12px;padding:12px;margin:14px 0;color:var(--muted);
    font-size:13px; line-height:1.5;
    border:1px solid rgba(255,255,255,0.02);
  }

  /* camera preview */
  .camera-wrap{
    margin-top:10px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.25));
  }
  video#video{
    display:block; width:100%; height:240px; object-fit:cover;
    filter: saturate(1.02) contrast(1.02);
  }

  /* controls */
  .controls{
    display:flex;gap:8px;margin-top:12px;
    align-items:center;flex-wrap:wrap;
  }

  .btn {
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    color:var(--accent-2);
    padding:10px 14px;border-radius:12px;
    cursor:pointer;font-weight:600;font-size:14px;
    display:inline-flex;align-items:center;gap:8px;
    transition:transform .15s ease, box-shadow .15s ease, opacity .12s;
  }
  .btn:hover{ transform:translateY(-3px); box-shadow:0 8px 30px rgba(0,0,0,0.45); }
  .btn.prim { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#012; box-shadow:0 10px 30px rgba(90,170,255,0.12); }
  .btn.ghost { color:var(--muted); background:transparent; border:1px dashed rgba(255,255,255,0.03); }

  input[type=file]{ display:none; }

  .status {
    margin-top:10px;font-size:14px;color:var(--muted);
    min-height:22px;
  }

  /* right column - results */
  .stage {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid var(--glass-border);
    border-radius:16px;padding:18px; position:relative;
  }
  .mood-card{
    display:flex;align-items:center;gap:16px;
  }
  .mood-emoji{
    width:84px;height:84px;border-radius:14px;
    background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    display:flex;align-items:center;justify-content:center;
    font-size:40px;
    border:1px solid rgba(255,255,255,0.03);
  }
  .mood-info h2{ margin:0;font-size:20px }
  .mood-info p{ margin:6px 0 0 0;color:var(--muted) }

  /* suggested tracks list */
  .tracks { margin-top:16px; display:grid; gap:10px; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); }
  .track {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    padding:10px;border-radius:10px;
    display:flex;flex-direction:column;gap:8px;
  }
  .track .title{ font-weight:700;font-size:13px;color:#e9fbff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .track .sub{ font-size:12px;color:var(--muted) }

  .play-btn {
    margin-top:auto;
    border-radius:10px;padding:8px 10px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    color:#012;font-weight:700;border:none;cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .play-btn:active{ transform:scale(.99); }

  /* flashy action when ready */
  .pulse {
    animation: pulseGlow 1.6s infinite;
    box-shadow: 0 10px 40px rgba(90,170,255,0.18), 0 0 40px rgba(90,170,255,0.08) inset;
  }
  @keyframes pulseGlow{
    0% { transform: translateY(0) scale(1); box-shadow: 0 6px 20px rgba(90,170,255,0.12); }
    50%{ transform: translateY(-4px) scale(1.02); box-shadow: 0 18px 40px rgba(90,170,255,0.22); }
    100%{ transform: translateY(0) scale(1); box-shadow: 0 6px 20px rgba(90,170,255,0.12); }
  }

  /* settings slide-in panel (from right) */
  .settings-drawer {
    position:fixed; right:20px; top:20px; width:360px; max-width:92vw;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    border-radius:14px; padding:14px; box-shadow: 0 10px 60px rgba(0,0,0,0.6);
    transform: translateX(420px); opacity:0; transition: transform .36s cubic-bezier(.2,.9,.2,1), opacity .28s;
    z-index:40;
  }
  .settings-drawer.open { transform: translateX(0); opacity:1; }

  .drawer-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
  .drawer-head h3 { margin:0;font-size:16px; }
  textarea { width:100%; min-height:64px; resize:vertical; padding:10px; border-radius:8px; background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.03); color:#dff7ff; }

  label.small { font-size:12px;color:var(--muted); display:block; margin-bottom:6px; }

  .drawer-actions{ display:flex; gap:8px; margin-top:10px; justify-content:flex-end;}
  .btn.save { background: linear-gradient(90deg,#46e6b0,#5aa9ff); color:#012; font-weight:800; }

  /* footer small */
  .foot { margin-top:12px; color:var(--muted); font-size:13px; text-align:center; }

  /* small responsive */
  @media (max-width:880px){
    .app{ grid-template-columns: 1fr; max-width:720px; }
    .camera-wrap video{ height:220px; }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="AI Mood DJ ‚Äî Dark UI">
    <!-- LEFT: controller -->
    <section class="panel" aria-label="Controls panel">
      <div class="brand header">
        <div class="logo">DJ</div>
        <div class="brand">
          <h1>AI Mood DJ</h1>
          <p>‡∏°‡∏¥‡∏ß‡∏™‡∏¥‡∏Ñ‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ/‡∏Å‡∏•‡πâ‡∏≠‡∏á</p>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <button id="openSettings" class="btn" title="Settings">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
          <button id="infoReset" class="btn ghost" title="Reset saved lists">‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </div>
      </div>

      <div class="howto" role="note">
        <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ (‡∏¢‡πà‡∏≠):</strong>
        <ol style="padding-left:18px;margin:8px 0 0 0;">
          <li>‡∏Å‡∏î <em>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</em> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå (‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)</li>
          <li>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‚Üí ‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</li>
          <li>AI ‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</li>
        </ol>
      </div>

      <div class="camera-wrap" aria-hidden="false">
        <video id="video" autoplay muted playsinline aria-label="Camera preview"></video>
      </div>

      <div class="controls">
        <label for="uploadFile" class="btn" title="Upload image">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</label>
        <input id="uploadFile" type="file" accept="image/*">
        <button id="snap" class="btn prim">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
        <button id="demoFace" class="btn">üëÅÔ∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      </div>

      <div class="status" id="statusArea">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö</div>

      <div class="foot">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (localStorage)</div>
    </section>

    <!-- RIGHT: mood stage -->
    <section class="stage" aria-label="Mood & tracks">
      <div class="mood-card" id="moodCard">
        <div class="mood-emoji" id="moodEmoji">üôÇ</div>
        <div class="mood-info">
          <h2 id="moodTitle">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
          <p id="moodDesc">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:14px;">
        <h3 style="margin:0;">‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
        <div style="color:var(--muted); font-size:13px;" id="detectedConfidence"></div>
      </div>

      <div class="tracks" id="tracksGrid" aria-live="polite" style="margin-top:10px;">
        <!-- generated track cards -->
      </div>

      <div id="rawDebug" style="margin-top:14px;color:var(--muted);font-size:12px;"></div>
    </section>
  </div>

  <!-- Settings drawer -->
  <aside class="settings-drawer" id="drawer" aria-hidden="true" role="dialog" aria-label="Music settings">
    <div class="drawer-head">
      <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</h3>
      <button id="closeDrawer" class="btn ghost" title="Close">‚úñÔ∏è</button>
    </div>

    <div>
      <label class="small">‡πÄ‡∏û‡∏•‡∏á ‚Äî ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏™‡∏∏‡∏Ç (happiness)</label>
      <textarea id="happinessLinks" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î..."></textarea>

      <label class="small" style="margin-top:8px;">‡πÄ‡∏û‡∏•‡∏á ‚Äî ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÄ‡∏®‡∏£‡πâ‡∏≤ (sadness)</label>
      <textarea id="sadnessLinks"></textarea>

      <label class="small" style="margin-top:8px;">‡πÄ‡∏û‡∏•‡∏á ‚Äî ‡πÇ‡∏Å‡∏£‡∏ò (anger)</label>
      <textarea id="angerLinks"></textarea>

      <label class="small" style="margin-top:8px;">‡πÄ‡∏û‡∏•‡∏á ‚Äî ‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏Å‡∏•‡∏≤‡∏á (neutral)</label>
      <textarea id="neutralLinks"></textarea>

      <div class="drawer-actions">
        <button id="saveSettings" class="btn save">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="closeSave" class="btn ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </aside>

<script>
/* -------------------------
   Configuration (keep if provided)
   ------------------------- */
const apiKey = "txJFYfuyTfkWF5J2BZRYGR6kOVotEq-4";
const apiSecret = "BhKRNGMyxO6SDvnFCQAy18VfP0Tdpn3L";

/* DOM */
const video = document.getElementById('video');
const snapBtn = document.getElementById('snap');
const uploadFile = document.getElementById('uploadFile');
const statusArea = document.getElementById('statusArea');
const moodTitle = document.getElementById('moodTitle');
const moodDesc = document.getElementById('moodDesc');
const moodEmoji = document.getElementById('moodEmoji');
const tracksGrid = document.getElementById('tracksGrid');
const detectedConfidence = document.getElementById('detectedConfidence');
const rawDebug = document.getElementById('rawDebug');

const drawer = document.getElementById('drawer');
const openSettings = document.getElementById('openSettings');
const closeDrawer = document.getElementById('closeDrawer');
const saveSettings = document.getElementById('saveSettings');
const closeSave = document.getElementById('closeSave');
const infoReset = document.getElementById('infoReset');

/* textareas */
const ids = ['happinessLinks','sadnessLinks','angerLinks','neutralLinks'];

/* initialize media */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
    video.srcObject = stream;
    statusArea.textContent = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ";
  }catch(err){
    console.warn(err);
    statusArea.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô";
  }
}
startCamera();

/* drawer control */
openSettings.addEventListener('click', ()=> {
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
});
closeDrawer.addEventListener('click', ()=> {
  drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true');
});
closeSave.addEventListener('click', ()=> { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); });

/* load saved lists */
function loadSaved(){
  ids.forEach(id => {
    const el = document.getElementById(id);
    el.value = localStorage.getItem(id) || "";
  });
}
loadSaved();

saveSettings.addEventListener('click', ()=> {
  ids.forEach(id => {
    const val = document.getElementById(id).value || "";
    localStorage.setItem(id, val);
  });
  statusArea.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
  drawer.classList.remove('open');
});

/* reset handler */
infoReset.addEventListener('click', ()=> {
  if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  ids.forEach(id => localStorage.removeItem(id));
  loadSaved();
  statusArea.textContent = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß";
});

/* helper: pick random link from textarea */
function getRandomFromTextarea(id){
  const raw = (document.getElementById(id).value || "").trim();
  if(!raw) return null;
  const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
  if(lines.length===0) return null;
  return lines[Math.floor(Math.random()*lines.length)];
}

/* capture helpers */
const canvas = document.createElement('canvas');
canvas.width = 640; canvas.height = 480;
const ctx = canvas.getContext('2d');

function showStatus(t){ statusArea.textContent = t; }

/* main photo: from camera */
snapBtn.addEventListener('click',()=>{
  showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á...');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob=> {
    const reader = new FileReader();
    reader.onloadend = ()=> {
      const b64 = reader.result.split(',')[1];
      analyzeEmotion(b64);
    };
    reader.readAsDataURL(blob);
  }, 'image/jpeg', 0.9);
});

/* file upload */
uploadFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  showStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...');
  const r = new FileReader();
  r.onloadend = ()=> {
    const b64 = r.result.split(',')[1];
    analyzeEmotion(b64);
  };
  r.readAsDataURL(f);
});

/* demo button (optional sample image) */
document.getElementById('demoFace').addEventListener('click', ()=> {
  // small sample face image (data URL omitted); instead show message
  showStatus('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á');
});

/* emotion mapping and emoji */
const MOOD_MAP = {
  happiness: {label: '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç', emoji:'üòÑ', desc:'‡∏•‡∏≠‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏î‡πÉ‡∏™‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏ô‡∏∏‡∏Å‡πÜ' },
  sadness:   {label: '‡πÄ‡∏®‡∏£‡πâ‡∏≤',   emoji:'üò¢', desc:'‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ö‡∏ä‡πâ‡∏≤ ‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏±‡∏á' },
  anger:     {label: '‡πÇ‡∏Å‡∏£‡∏ò',    emoji:'üò†', desc:'‡πÄ‡∏û‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢' },
  neutral:   {label: '‡∏õ‡∏Å‡∏ï‡∏¥',   emoji:'üòê', desc:'‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏ö‡∏≤ ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠ lo-fi' }
};

/* analyze via Face++ */
async function analyzeEmotion(imageBase64){
  showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå...');
  moodTitle.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
  moodDesc.textContent = '';
  tracksGrid.innerHTML = '';
  detectedConfidence.textContent = '';

  const params = new URLSearchParams();
  params.append('api_key', apiKey);
  params.append('api_secret', apiSecret);
  params.append('image_base64', imageBase64);
  params.append('return_attributes', 'emotion');

  try{
    const res = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
      method:'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: params.toString()
    });
    const data = await res.json();

    if(!data || !data.faces || data.faces.length === 0){
      showStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û');
      moodTitle.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤';
      moodEmoji.textContent = '‚ùì';
      moodDesc.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô';
      return;
    }

    // pick top emotion
    const emotions = data.faces[0].attributes.emotion;
    const sorted = Object.entries(emotions).sort((a,b)=>b[1]-a[1]);
    let top = sorted[0][0]; // e.g., "happiness"

    // map some Face++ emotions into our categories
    if(top === 'surprise') top = 'happiness';
    if(top === 'disgust' || top === 'fear') top = 'sadness';

    // set UI
    const conf = Math.round(sorted[0][1]);
    const mood = MOOD_MAP[top] ? top : 'neutral';
    moodTitle.textContent = MOOD_MAP[mood].label;
    moodEmoji.textContent = MOOD_MAP[mood].emoji;
    moodDesc.textContent = MOOD_MAP[mood].desc;
    detectedConfidence.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${conf}%`;

    showStatus('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥');
    renderTracksForMood(mood, emotions);

    // debug blob
    rawDebug.textContent = `Raw emotions: ${JSON.stringify(emotions)}`;

  }catch(err){
    console.error(err);
    showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API');
    moodTitle.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
    moodEmoji.textContent = '‚ö†Ô∏è';
    moodDesc.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ';
  }
}

/* create track list UI */
function renderTracksForMood(mood, emotions){
  tracksGrid.innerHTML = '';
  const fallback = {
    happiness: ['https://www.youtube.com/watch?v=ekr2nIex040'],
    sadness: ['https://www.youtube.com/watch?v=Jkj36B1YuDU'],
    anger: ['https://www.youtube.com/watch?v=eTedtzozrAo'],
    neutral: ['https://www.youtube.com/watch?v=5qap5aO4i9A']
  };
  // first try to get from saved lists
  const saved = (localStorage.getItem(mood+'Links') || localStorage.getItem({
    happiness:'happinessLinks', sadness:'sadnessLinks', anger:'angerLinks', neutral:'neutralLinks'
  }[mood]) ) || '';

  // read either textarea id form or earlier naming compatibility
  const listFromStore = (document.getElementById(mood+'Links') && document.getElementById(mood+'Links').value) ||
                        (document.getElementById(mood==='happiness' ? 'happinessLinks' : mood+'Links') && document.getElementById(mood+'Links').value) ||
                        saved;

  let arr;
  if(listFromStore && listFromStore.trim()){
    arr = listFromStore.split('\n').map(s=>s.trim()).filter(Boolean);
  } else {
    arr = fallback[mood] || [fallback['neutral'][0]];
  }

  // create up to 6 items (or dup if only 1)
  const items = [];
  for(let i=0;i<Math.min(6, Math.max(1, arr.length)); i++){
    items.push(arr[i % arr.length]);
  }

  items.forEach((url, idx)=>{
    const card = document.createElement('div');
    card.className = 'track';
    const t = document.createElement('div'); t.className='title';
    t.textContent = (new URL(url)).searchParams.get('v') ? `YouTube ‚Ä¢ ${ (new URL(url)).searchParams.get('v') }` : url;
    const s = document.createElement('div'); s.className='sub';
    s.textContent = url;
    const btn = document.createElement('button');
    btn.className = 'play-btn';
    btn.textContent = '‚ñ∂Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏á';
    btn.addEventListener('click', ()=> {
      window.open(url, '_blank', 'noopener');
    });

    card.appendChild(t);
    card.appendChild(s);
    card.appendChild(btn);

    // animate the first card to pulse (call-to-action)
    if(idx===0){
      btn.classList.add('pulse');
      // small extra: add tooltip like step
      setTimeout(()=>btn.classList.remove('pulse'), 10000); // pulse for 10s max
    }

    tracksGrid.appendChild(card);
  });
}

/* accessibility: allow drop of images */
window.addEventListener('dragover', e=> e.preventDefault());
window.addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f && f.type && f.type.startsWith('image/')){
    const r = new FileReader();
    r.onloadend = ()=> {
      const b64 = r.result.split(',')[1];
      analyzeEmotion(b64);
    };
    r.readAsDataURL(f);
  }else{
    // nothing
  }
});

/* On load, ensure textareas exist (for compatibility) */
(function ensureTextareas(){
  ids.forEach(id=>{
    if(!document.getElementById(id)){
      // copy values from storage into a hidden element (not necessary, but keep compatibility)
      const ta = document.createElement('textarea');
      ta.id = id;
      ta.style.display = 'none';
      document.body.appendChild(ta);
      ta.value = localStorage.getItem(id) || '';
    }
  });
})();

/* small polyfill: if page loaded and camera not allowed, still allow upload */
showStatus('‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ');

/* end of script */
</script>
</body>
</html>
