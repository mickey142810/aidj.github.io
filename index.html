<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Mood DJ ‚Äî Live Mood Detection</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">

<!-- FACE API -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
:root{
  --bg-1:#081223;
  --bg-2:#0d1a28;
  --card:#102533;
  --muted:#9fb3c8;
  --accent:#6ee7b7;
  --accent-2:#5aa9ff;
  --glass: rgba(255,255,255,0.04);
  --danger:#ff7a7a;
}
html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue";-webkit-font-smoothing:antialiased;}
body{
  background: radial-gradient(1200px 600px at 10% 10%, #0b2b3a 0%, transparent 10%),
              radial-gradient(900px 500px at 90% 90%, #07203a 0%, transparent 10%),
              linear-gradient(180deg,var(--bg-1),var(--bg-2));
  padding:28px;
  display:flex;justify-content:center;align-items:flex-start;
  color:#d8eef7;
}
.app{width:100%;max-width:1100px;display:grid;grid-template-columns:420px 1fr;gap:22px;}
.panel, .stage{
  background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.05);
  border-radius:16px;padding:18px;
}
.logo{width:58px;height:58px;background:linear-gradient(135deg,var(--accent),var(--accent-2));border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#012;font-size:20px;}
.btn{padding:10px 14px;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:var(--accent-2);font-weight:600;}
.btn.prim{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#012;}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.05);color:var(--muted);}
video{width:100%;height:240px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.05);background:#0005;display:block;}
.canvasOverlay{position:absolute;left:0;top:0;pointer-events:none;border-radius:12px;}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
textarea{width:100%;background:#0004;border:1px solid #ffffff10;padding:10px;border-radius:10px;color:#dff7ff;min-height:48px;}
.track{padding:12px;background:#ffffff06;border:1px solid #ffffff10;border-radius:12px;}
.play-btn{margin-top:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:8px 10px;border:none;border-radius:10px;color:#012;font-weight:700;cursor:pointer;}
.statusLine{margin-top:8px;color:var(--muted);font-size:13px;}
.overlayContainer{position:relative;border-radius:12px;overflow:hidden;}
.moodBadge{display:flex;align-items:center;gap:10px;}
.moodEmoji{font-size:48px;}
.small{font-size:12px;color:var(--muted);display:block;margin-top:8px;}
</style>
</head>

<body>
<div class="app">

  <!-- LEFT PANEL -->
  <section class="panel">
    <div style="display:flex;gap:12px;align-items:center;">
      <div class="logo">DJ</div>
      <div>
        <h2 style="margin:0;font-size:20px;">AI Mood DJ</h2>
        <p style="margin:0;color:var(--muted);font-size:13px;">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Live Mood Detection ‚Äî ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
      </div>
      <button id="openSettings" class="btn" style="margin-left:auto;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <div class="howto small" style="margin-top:10px;color:var(--muted);font-size:13px;">
      1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Preset ‚Üí 2) ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏•‡∏á ‚Üí 3) ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏° Live ‚Üí 4) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    </div>

    <div class="overlayContainer" style="margin-top:12px;">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay" class="canvasOverlay"></canvas>
    </div>

    <div class="controls" style="margin-top:10px;">
      <label class="btn" for="uploadFile">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</label>
      <input id="uploadFile" type="file" accept="image/*" style="display:none;">
      <button id="snap" class="btn prim">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
      <button id="demoFace" class="btn">üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      <button id="startLive" class="btn prim">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏° Live</button>
      <button id="stopLive" class="btn ghost">‚èπ ‡∏´‡∏¢‡∏∏‡∏î Live</button>
    </div>

    <div id="statusArea" class="statusLine">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</div>
    <div id="identityArea" class="statusLine"></div>
    <div id="fpsArea" class="statusLine"></div>
  </section>

  <!-- RIGHT PANEL ‚Üí MOOD RESULT -->
  <section class="stage">
    <div style="display:flex;gap:16px;align-items:center;">
      <div id="moodEmoji" class="moodEmoji">üôÇ</div>
      <div>
        <h2 id="moodTitle" style="margin:0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
        <p id="moodDesc" style="margin:0;color:var(--muted);">‡∏£‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á...</p>
      </div>
    </div>

    <div id="detectedConfidence" style="margin-top:10px;color:var(--muted);"></div>

    <h3 style="margin-top:14px;">‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
    <div id="tracksGrid" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));"></div>
  </section>
</div>

<!-- SETTINGS DRAWER -->
<aside id="drawer" style="position:fixed;right:20px;top:20px;width:360px;max-width:90vw;background:#ffffff08;padding:16px;border-radius:16px;transform:translateX(420px);transition:.35s;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏•‡∏á + Preset</h3>
    <button id="closeDrawer" class="btn ghost">‚úñÔ∏è</button>
  </div>

  <label class="small">Preset Pack:</label>
  <select id="presetSelect" class="btn" style="width:100%;margin-top:4px;">
    <option value="none">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ preset --</option>
    <option value="basic">üéß Basic Pack</option>
    <option value="chill">üòé Chill Pack</option>
    <option value="thaipop">üé§ Thai Pop Pack</option>
    <option value="gamer">üïπÔ∏è Gamer Pack</option>
  </select>

  <button id="applyPreset" class="btn prim" style="width:100%;margin-top:10px;">‡πÇ‡∏´‡∏•‡∏î Preset</button>

  <label class="small" style="margin-top:10px;">Happiness</label>
  <textarea id="happinessLinks"></textarea>

  <label class="small">Sadness</label>
  <textarea id="sadnessLinks"></textarea>

  <label class="small">Anger</label>
  <textarea id="angerLinks"></textarea>

  <label class="small">Neutral</label>
  <textarea id="neutralLinks"></textarea>

  <button id="saveSettings" class="btn prim" style="width:100%;margin-top:10px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</aside>

<script>
/* ---------------------------------------
      MODELS + INITIALIZATION
--------------------------------------- */
const MODEL_URL = "https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/models";

const statusArea = document.getElementById("statusArea");
const identityArea = document.getElementById("identityArea");
const fpsArea = document.getElementById("fpsArea");
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const overlayCtx = overlay.getContext("2d");

let modelsLoaded = false;
let liveRunning = false;
let lastProcess = 0;
let processInterval = 400; // ms between analyzes
let lastFPSupdate = Date.now();
let framesCount = 0;

async function loadModels() {
  statusArea.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• face-api.js ...";
  try {
    // detection + landmarks + expressions + optional recognition
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    // optional: face recognition net is available if needed later
    // await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    modelsLoaded = true;
    statusArea.textContent = "‚úî ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
  } catch (e) {
    console.error(e);
    statusArea.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e.message;
  }
}
loadModels();

/* CAMERA */
async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
    video.srcObject = stream;
    await video.play();
    // sync overlay size
    overlay.width = video.videoWidth || 640;
    overlay.height = video.videoHeight || 360;
  } catch (e) {
    console.error("Camera error:", e);
    statusArea.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + e.message;
  }
}
startCamera();

/* PRESET DATA */
const ids = ["happinessLinks","sadnessLinks","angerLinks","neutralLinks"];
const presetData = {
  basic:{happiness:["https://youtube.com/playlist?list=PLgzTt0k8mXzF2fleyxQ17JxeccHFC8Gxp"],sadness:["https://youtu.be/POETazMpykQ"],anger:["https://youtu.be/t9mCFx_zF8U"],neutral:["https://youtu.be/n61ULEU7CO0"]},
  chill:{happiness:["https://youtu.be/xNSx7NYZ4fM"],sadness:["https://youtu.be/_c7xxwWbljk"],anger:["https://youtu.be/6m2Ma8uX74s"],neutral:["https://youtu.be/EkVbIfRPQAg"]},
  thaipop:{happiness:["https://youtu.be/nJFJvO83o_s"],sadness:["https://youtu.be/eY7iqYmQNhE"],anger:["https://youtube.com/playlist?list=PLZSdxWoL6_WD8dpQE9iluLw3yYVQJphYp"],neutral:["https://youtu.be/aHoyTRlHCr4"]},
  gamer:{happiness:["https://youtu.be/ih2xubMaZWI"],sadness:["https://youtu.be/M1YriKcNIco"],anger:["https://youtube.com/playlist?list=PL6Y6az3uyYAZJailKdu-zkc9JnvCyvgoN"],neutral:["https://youtu.be/3fxq7kqyWO8"]}
};

/* LOAD SAVED */
function loadSaved() {
  ids.forEach(id => document.getElementById(id).value = localStorage.getItem(id) || "");
}
loadSaved();

/* APPLY PRESET */
function applyPreset(key){
  const p = presetData[key];
  if(!p) return;
  document.getElementById("happinessLinks").value = p.happiness.join("\n");
  document.getElementById("sadnessLinks").value = p.sadness.join("\n");
  document.getElementById("angerLinks").value = p.anger.join("\n");
  document.getElementById("neutralLinks").value = p.neutral.join("\n");
}

document.getElementById("applyPreset").onclick = () => {
  const v = document.getElementById("presetSelect").value;
  if(v !== "none") applyPreset(v);
};

document.getElementById("saveSettings").onclick = () => {
  ids.forEach(id => localStorage.setItem(id, document.getElementById(id).value));
  drawer.style.transform = "translateX(420px)";
};

document.getElementById("openSettings").onclick = ()=> drawer.style.transform="translateX(0)";
document.getElementById("closeDrawer").onclick = ()=> drawer.style.transform="translateX(420px)";

/* UTIL */
function getRandom(id){
  const list = (document.getElementById(id).value || "")
    .split("\n").map(s=>s.trim()).filter(Boolean);
  return list[Math.floor(Math.random()*list.length)];
}

function updateMood(mood,conf){
  document.getElementById("moodTitle").textContent = mood ? mood : "neutral";
  document.getElementById("detectedConfidence").textContent = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: "+(conf||0)+"%";
  const emo = { happiness:"üòÑ", sadness:"üò¢", anger:"üò°", neutral:"üòê" };
  document.getElementById("moodEmoji").textContent = emo[mood]||"üôÇ";

  let field = {
    happiness:"happinessLinks",
    sadness:"sadnessLinks",
    anger:"angerLinks",
    neutral:"neutralLinks"
  }[mood];

  const link = getRandom(field);
  const grid = document.getElementById("tracksGrid");
  grid.innerHTML = "";

  if(link){
    const div = document.createElement("div");
    div.className = "track";
    div.innerHTML = `
      <div style="font-size:13px;word-break:break-all">${link}</div>
      <button class="play-btn">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô</button>`;
    const btn = div.querySelector("button");
    btn.onclick = ()=> window.open(link, "_blank");
    grid.appendChild(div);
  }
}

/* ---------------------------------------
      FACE EXPRESSION API (single function)
--------------------------------------- */
async function getFaceExpression(input) {
  // detection options tuned for speed
  const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
  const detection = await faceapi
    .detectSingleFace(input, options)
    .withFaceLandmarks()
    .withFaceExpressions();

  if (!detection) {
    return {
      expression: "neutral",
      confidence: 0,
      raw: null,
      detection: null
    };
  }

  const exp = detection.expressions;
  const sorted = Object.entries(exp).sort((a, b) => b[1] - a[1]);
  const [top, conf] = sorted[0];

  const convert = {
    happy: "happiness",
    sad: "sadness",
    angry: "anger",
    disgusted: "anger",
    fearful: "sadness",
    surprised: "happiness",
    neutral: "neutral"
  };

  return {
    expression: convert[top] || "neutral",
    confidence: Math.round(conf * 100),
    raw: exp,
    detection
  };
}

/* ---------------------------------------
      LIVE LOOP (throttled) + DRAWING
--------------------------------------- */
async function processFrame() {
  if (!modelsLoaded || !video || video.readyState < 2) return;

  const now = Date.now();
  if (now - lastProcess < processInterval) return; // throttle
  lastProcess = now;

  // prepare a small canvas to analyze
  // we can pass video element directly to face-api
  const res = await getFaceExpression(video);

  // update UI
  updateMood(res.expression, res.confidence);

  // draw overlay
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;
  overlayCtx.clearRect(0,0,overlay.width,overlay.height);

  if (res.detection && res.detection.detection) {
    const box = res.detection.detection.box;
    overlayCtx.lineWidth = Math.max(2, Math.round(overlay.width/300));
    overlayCtx.strokeStyle = "rgba(90,170,255,0.9)";
    overlayCtx.fillStyle = "rgba(10,10,10,0.45)";
    overlayCtx.beginPath();
    overlayCtx.rect(box.x, box.y, box.width, box.height);
    overlayCtx.stroke();

    // label background
    const label = `${res.expression} (${res.confidence}%)`;
    overlayCtx.font = `${Math.max(12, Math.round(overlay.width/60))}px sans-serif`;
    const textW = overlayCtx.measureText(label).width;
    const pad = 6;
    overlayCtx.fillRect(box.x, box.y - 30, textW + pad*2, 28);

    overlayCtx.fillStyle = "#fff";
    overlayCtx.fillText(label, box.x + pad, box.y - 10);
  } else {
    // no face found
    overlayCtx.fillStyle = "rgba(255,255,255,0.03)";
    overlayCtx.font = "14px sans-serif";
    overlayCtx.fillText("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤", 10, 20);
  }

  // fps counter (simple)
  framesCount++;
  if (Date.now() - lastFPSupdate > 1000) {
    fpsArea.textContent = `FPS (‡∏ï‡∏£‡∏ß‡∏à): ${framesCount} /s`;
    framesCount = 0;
    lastFPSupdate = Date.now();
  }
}

/* start/stop live */
let rafId = null;
function liveLoop(){
  if (!liveRunning) return;
  processFrame().catch(e=>console.error(e));
  rafId = requestAnimationFrame(liveLoop);
}

document.getElementById("startLive").onclick = ()=>{
  if (!modelsLoaded) {
    alert("‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
    return;
  }
  liveRunning = true;
  statusArea.textContent = "üî¥ Live: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå...";
  lastProcess = 0;
  if (!video.srcObject) startCamera();
  if (rafId) cancelAnimationFrame(rafId);
  liveLoop();
};

document.getElementById("stopLive").onclick = ()=>{
  liveRunning = false;
  statusArea.textContent = "‚èπ Live ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß";
  if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
  overlayCtx.clearRect(0,0,overlay.width,overlay.height);
};

/* ---------------------------------------
      SNAP + UPLOAD + DEMO
--------------------------------------- */
document.getElementById("snap").onclick = async ()=>{
  // create canvas from video
  const c = document.createElement("canvas");
  c.width = video.videoWidth;
  c.height = video.videoHeight;
  c.getContext("2d").drawImage(video, 0, 0, c.width, c.height);
  const img = new Image();
  img.src = c.toDataURL();
  img.onload = ()=> analyzeImage(img);
};

async function analyzeImage(input) {
  if (!modelsLoaded) { statusArea.textContent = "‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"; return; }
  const r = await getFaceExpression(input);
  updateMood(r.expression, r.confidence);
  statusArea.textContent = "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û: " + r.expression + " (" + r.confidence + "%)";
  // draw result once
  overlay.width = input.width || video.videoWidth;
  overlay.height = input.height || video.videoHeight;
  overlayCtx.clearRect(0,0,overlay.width,overlay.height);
  if (r.detection && r.detection.detection) {
    const b = r.detection.detection.box;
    overlayCtx.lineWidth = 2;
    overlayCtx.strokeStyle = "rgba(90,170,255,0.9)";
    overlayCtx.strokeRect(b.x, b.y, b.width, b.height);
    overlayCtx.font = "16px sans-serif";
    overlayCtx.fillStyle = "rgba(10,10,10,0.6)";
    overlayCtx.fillRect(b.x, b.y - 26, 120, 22);
    overlayCtx.fillStyle = "#fff";
    overlayCtx.fillText(`${r.expression} (${r.confidence}%)`, b.x + 6, b.y - 8);
  }
}

document.getElementById("uploadFile").onchange = async ev=>{
  const file = ev.target.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = ()=> analyzeImage(img);
  img.src = URL.createObjectURL(file);
};

document.getElementById("demoFace").onclick = ()=>{
  const demo = new Image();
  demo.crossOrigin="anonymous";
  demo.src="https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/examples/images/bbt1.jpg";
  demo.onload = ()=> analyzeImage(demo);
};

/* ---------------------------------------
      OPTIONAL: adjust interval slider (quick hack)
--------------------------------------- */
const drawer = document.getElementById("drawer");
const idsInputs = ids.map(id=>document.getElementById(id));
loadSaved();

/* small safety: stop camera on page unload */
window.addEventListener("beforeunload", ()=>{
  if (video.srcObject) {
    const tracks = video.srcObject.getTracks();
    tracks.forEach(t => t.stop());
  }
});
</script>

</body>
</html>
